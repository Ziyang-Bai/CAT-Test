<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT Test v0.4 - Public</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        #results { margin-top: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; }
        .pass { color: green; }
        .fail { color: red; }
        .details { margin-top: 10px; font-size: 0.9em; display: none; }
        .expand-btn { cursor: pointer; color: blue; text-decoration: underline; margin-left: 10px; font-size: 0.9em; }
        #progress { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>CAT Test v0.4 - Public</h1>
    <p>This is a browser compatibility and feature test. Click "Run Tests" to evaluate your browser's capabilities.</p>
    <p><strong>Note:</strong> This test includes a check for Content Security Policy (CSP) which may affect the loading of certain resources for security purposes.</p>
    <button id="runTestsButton">Run Tests</button>
    <div id="progress"></div>
    <div id="results"></div>
    <p>View the project on <a href="https://github.com/elefish-top/CAT-Test" target="_blank">GitHub</a>.</p>
    <p id="ipAddress">Fetching IP address...</p>

    <script>
        function runTests() {
            var results = document.getElementById('results');
            var progress = document.getElementById('progress');
            results.innerHTML = '<h2>Running Tests...</h2>';
            progress.innerHTML = '';

            // Fetch and display the user's IP address
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ipAddress').textContent = 'Your IP Address: ' + data.ip;
                })
                .catch(error => {
                    document.getElementById('ipAddress').textContent = 'Unable to fetch IP address.';
                });

            var tests = [
                { 
                    name: "Async/Await Support", 
                    test: function() {
                        try {
                            var result = typeof (async function() {}).constructor === "function";
                            return { result: result, logs: ["Checking async/await support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in async/await check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports modern JavaScript async/await syntax for asynchronous programming."
                },
                { 
                    name: "Canvas Support", 
                    test: function() {
                        try {
                            var result = !!document.createElement('canvas').getContext;
                            return { result: result, logs: ["Canvas support detected: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in canvas support check: " + e.message] };
                        }
                    },
                    details: "Checks if the HTML5 Canvas API is available for drawing graphics and animations."
                },
                { 
                    name: "CSS Grid Support", 
                    test: function() {
                        try {
                            var result = CSS.supports("display", "grid");
                            return { result: result, logs: ["CSS Grid support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in CSS Grid check: " + e.message] };
                        }
                    },
                    details: "Verifies if the browser supports CSS Grid for advanced layout designs."
                },
                { 
                    name: "CSS Variables Support", 
                    test: function() {
                        try {
                            var result = CSS.supports("color", "var(--primary-color)");
                            return { result: result, logs: ["CSS Variables support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in CSS Variables check: " + e.message] };
                        }
                    },
                    details: "Ensures the browser supports CSS custom properties (variables)."
                },
                { 
                    name: "HTTPS Connection", 
                    test: function() {
                        try {
                            var result = location.protocol === 'https:';
                            return { result: result, logs: ["HTTPS connection: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in HTTPS check: " + e.message] };
                        }
                    },
                    details: "Confirms if the page is loaded over a secure HTTPS connection. This check will not work if you are accessing locally, or if the server does not have a valid SSL certificate."

                },
                { 
                    name: "WebAssembly Support", 
                    test: function() {
                        try {
                            var result = typeof WebAssembly !== "undefined";
                            return { result: result, logs: ["WebAssembly support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in WebAssembly check: " + e.message] };
                        }
                    },
                    details: "Checks for WebAssembly, which enables high-performance applications in the browser."
                },
                { 
                    name: "WebRTC Support", 
                    test: function() {
                        try {
                            var result = 'RTCPeerConnection' in window;
                            return { result: result, logs: ["WebRTC support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in WebRTC check: " + e.message] };
                        }
                    },
                    details: "Tests for WebRTC, allowing peer-to-peer communication, such as video calls."
                },
                { 
                    name: "Service Worker Support", 
                    test: function() {
                        try {
                            var result = 'serviceWorker' in navigator;
                            return { result: result, logs: ["Service Worker support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Service Worker check: " + e.message] };
                        }
                    },
                    details: "Verifies if the browser supports Service Workers for offline capabilities and push notifications."
                },
                { 
                    name: "CSP Support", 
                    test: function() {
                        try {
                            var meta = document.createElement('meta');
                            meta.httpEquiv = "Content-Security-Policy";
                            meta.content = "default-src 'self'";
                            document.head.appendChild(meta);
                            var result = true;
                            return { result: result, logs: ["CSP meta tag added."] };
                        } catch (e) {
                            return { result: false, logs: ["Error in CSP check: " + e.message] };
                        }
                    },
                    details: "Tests Content Security Policy (CSP) implementation to prevent unsafe resources."
                },
                { 
                    name: "LocalStorage Support", 
                    test: function() {
                        try {
                            var result = 'localStorage' in window && window['localStorage'] !== null;
                            return { result: result, logs: ["LocalStorage support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in LocalStorage check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports LocalStorage for storing data locally."
                },
                { 
                    name: "IndexedDB Support", 
                    test: function() {
                        try {
                            var result = 'indexedDB' in window;
                            return { result: result, logs: ["IndexedDB support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in IndexedDB check: " + e.message] };
                        }
                    },
                    details: "Verifies if the browser supports IndexedDB for storing large amounts of structured data."
                },
                { 
                    name: "Geolocation API Support", 
                    test: function() {
                        try {
                            var result = 'geolocation' in navigator;
                            return { result: result, logs: ["Geolocation API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Geolocation API check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Geolocation API for accessing the device's location."
                },
                { 
                    name: "WebSockets Support", 
                    test: function() {
                        try {
                            var result = 'WebSocket' in window;
                            return { result: result, logs: ["WebSockets support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in WebSockets check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports WebSockets for real-time communication."
                },
                { 
                    name: "Flexbox Support", 
                    test: function() {
                        try {
                            var result = CSS.supports("display", "flex");
                            return { result: result, logs: ["Flexbox support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Flexbox check: " + e.message] };
                        }
                    },
                    details: "Verifies if the browser supports CSS Flexbox for flexible layouts."
                },
                { 
                    name: "ES6 Support", 
                    test: function() {
                        try {
                            var result = (function() { try { new Function("(a = 0) => a"); return true; } catch (err) { return false; } })();
                            return { result: result, logs: ["ES6 support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in ES6 check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports ECMAScript 6 (ES6) features."
                },
                {
                    name: "WebGL Support",
                    test: function() {
                        try {
                            var canvas = document.createElement('canvas');
                            var result = !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
                            return { result: result, logs: ["WebGL support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in WebGL check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports WebGL for 3D graphics rendering."
                },
                {
                    name: "SVG Support",
                    test: function() {
                        try {
                            var result = !!document.createElementNS && !!document.createElementNS("http://www.w3.org/2000/svg", "svg").createSVGRect;
                            return { result: result, logs: ["SVG support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in SVG check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports SVG (Scalable Vector Graphics) for rendering vector images."
                },
                { 
                    name: "Network Information API", 
                    test: function() {
                        try {
                            var result = 'connection' in navigator;
                            return { result: result, logs: ["Network Information API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Network Information API check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Network Information API, providing details about the user's network connection."
                },
                { 
                    name: "Pointer Events Support", 
                    test: function() {
                        try {
                            var result = 'PointerEvent' in window;
                            return { result: result, logs: ["Pointer Events support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Pointer Events check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports Pointer Events, used for handling mouse, touch, and pen input in a unified way."
                },
                { 
                    name: "Payment Request API", 
                    test: function() {
                        try {
                            var result = 'PaymentRequest' in window;
                            return { result: result, logs: ["Payment Request API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Payment Request API check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Payment Request API, allowing for easier and more secure online payments."
                },
                { 
                    name: "Web NFC Support", 
                    test: function() {
                        try {
                            var result = 'NFC' in window;
                            return { result: result, logs: ["Web NFC support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Web NFC check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Web NFC API for enabling Near Field Communication interactions."
                },
                { 
                    name: "WebVR/WebXR Support", 
                    test: function() {
                        try {
                            var result = 'getUserMedia' in navigator || 'xr' in navigator;
                            return { result: result, logs: ["WebVR/WebXR support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in WebVR/WebXR check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports WebVR or WebXR for Virtual Reality and Augmented Reality experiences."
                },
                { 
                    name: "Web Speech API - Speech Recognition", 
                    test: function() {
                        try {
                            var result = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
                            return { result: result, logs: ["Web Speech API (Speech Recognition) support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Web Speech API check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Web Speech API for speech recognition, allowing voice input."
                },
                { 
                    name: "Clipboard API", 
                    test: function() {
                        try {
                            var result = 'clipboard' in navigator;
                            return { result: result, logs: ["Clipboard API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Clipboard API check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports the Clipboard API for reading and writing content to the clipboard."
                },
                { 
                    name: "Web Push Notifications", 
                    test: function() {
                        try {
                            var result = 'PushManager' in window;
                            return { result: result, logs: ["Web Push Notifications support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Web Push Notifications check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports Web Push Notifications, allowing websites to send notifications to users."
                },
                { 
                    name: "File System Access API", 
                    test: function() {
                        try {
                            var result = 'showOpenFilePicker' in window;
                            return { result: result, logs: ["File System Access API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in File System Access API check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports the File System Access API, allowing websites to read and write files to the local file system."
                },
                { 
                    name: "Audio Worklet API", 
                    test: function() {
                        try {
                            var result = 'AudioWorklet' in window;
                            return { result: result, logs: ["Audio Worklet support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Audio Worklet check: " + e.message] };
                        }
                    },
                    details: "Checks if the browser supports Audio Worklet API for real-time audio processing and synthesis."
                },
                { 
                    name: "Background Sync API", 
                    test: function() {
                        try {
                            var result = 'SyncManager' in window;
                            return { result: result, logs: ["Background Sync API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Background Sync API check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Background Sync API, allowing websites to synchronize data in the background."
                },
                { 
                    name: "Web Bluetooth API", 
                    test: function() {
                        try {
                            var result = 'bluetooth' in navigator;
                            return { result: result, logs: ["Web Bluetooth API support: " + (result ? "PASS" : "FAIL")] };
                        } catch (e) {
                            return { result: false, logs: ["Error in Web Bluetooth check: " + e.message] };
                        }
                    },
                    details: "Tests if the browser supports the Web Bluetooth API for connecting and interacting with Bluetooth devices."
                }

                
            ];

            results.innerHTML = ''; // Clear previous results
            for (var i = 0; i < tests.length; i++) {
                (function(test, index) {
                    setTimeout(function() {
                        var resultData;
                        try {
                            resultData = test.test(); // Execute test
                        } catch (e) {
                            resultData = { result: false, logs: ["Error running test: " + e.message] }; // Handle errors
                        }

                        var div = document.createElement('div');
                        div.className = 'test ' + (resultData.result ? 'pass' : 'fail');
                        div.innerHTML = '\
                            <span>' + test.name + ': ' + (resultData.result ? 'PASS' : 'FAIL') + '</span>\
                            <span class="expand-btn">[Details]</span>\
                            <div class="details">\
                                <p>' + test.details + '</p>\
                                <pre>' + resultData.logs.join("\n") + '</pre>\
                            </div>\
                        ';
                        results.appendChild(div);

                        // Update progress
                        progress.innerHTML = 'Progress: ' + (index + 1) + '/' + tests.length + ' tests completed';

                        // Bind event to the expand button
                        var expandButton = div.querySelector('.expand-btn');
                        expandButton.addEventListener('click', function() {
                            toggleDetails(expandButton);
                        });

                    }, i * 100); // Delay each test to simulate progress
                })(tests[i], i);
            }

            // Add summary
            setTimeout(function() {
                var totalTests = tests.length;
                var passedTests = document.querySelectorAll('.pass').length;
                var summary = document.createElement('div');
                summary.innerHTML = '<h3>Summary: ' + passedTests + '/' + totalTests + ' tests passed</h3>';
                results.appendChild(summary);

                // Add user agent information
                var uaInfo = document.createElement('div');
                uaInfo.innerHTML = '<h3>User Agent: ' + navigator.userAgent + '</h3>';
                results.insertBefore(uaInfo, results.firstChild);
            }, tests.length * 100);
        }

        // Toggle detailed information
        function toggleDetails(btn) {
            var detailsDiv = btn.closest('.test').querySelector('.details');
            if (detailsDiv) {
                console.log("Toggling details..."); // 调试输出
                if (detailsDiv.style.display === 'block') {
                    detailsDiv.style.display = 'none';
                    btn.textContent = '[Details]';  // 更新按钮文本
                } else {
                    detailsDiv.style.display = 'block';
                    btn.textContent = '[Hide]';  // 更新按钮文本
                }
            }
        }

        // Bind runTests to the button
        document.getElementById('runTestsButton').addEventListener('click', runTests);
    </script>
</body>
</html>
